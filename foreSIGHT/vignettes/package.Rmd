---
title: "A quick tour of exposure"
author: "Dr Bree Bennett, Sam Culley"
date: "22/05/17"
output: 
      rmarkdown::html_vignette:
           css: "mystyles1.css"
vignette: >
  %\VignetteIndexEntry{A quick tour of...}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(fig.align="center",
               fig.width=5, fig.height=4,
               dev.args=list(pointsize=8),
               par=TRUE)

knit_hooks$set(par = function(before, options, envir)
  { if(before && options$fig.show != "none") 
       par(mar=c(4.1,4.1,1.1,1.1), mgp=c(3,1,0), tcl=-0.5)
})
```

# Introduction

A scenario neutral approach to climate change impact analyses. 


$$
OF=\sqrt{\sum_{i=1}^n(t_i-a_{si})^2}
$$
where $t_i$ is a vector of the desired attributes, $a_{si}$ is a vector of calcualted attributes for a simulated time series, and $n$ attributes are requested. The argument attSel controls the requested attributes, with a full list available in the documentation.

This document gives a quick tour of **exposure** (version `r packageVersion("exposure")`) functionalities. It was written in R Markdown, using the [knitr](http://cran.r-project.org/package=knitr) package for production. 

# Exposure Spaces

This package outputs the necessary data to create exposure spaces. Each output file is a time series with daily entries of the requested variables. The files are titled by their "co-ordinates" in the exposure space, which are the same as the requested targets. e.g. "1.1P-ann-tot-m_3Temp-ann-avg-m.csv"

```{r include=FALSE}

load("vignette.Rdata")

attSel<-attPrim<-c("P_ann_tot_m","Temp_ann_avg_m")     #In this case all specified attributes are on an axis

exSpArgs<-list(type = "regGrid",
               samp = c(7,6),
               bounds = list("P_ann_tot_m"=c(0.9,1.5), #bounds entries match the order in attSel
                             "Temp_ann_avg_m"=c(-1,4)))
attInfo=list(varType=c("P","Temp"),targetType=c("frac","diff"))

     targetMat=expSpaceSampler(type=exSpArgs$type,
                               samp=exSpArgs$samp,
                               bounds=exSpArgs$bounds,
                               varType=attInfo$varType,
                               targetType=attInfo$targetType,
                               attSel=attSel,
                               file)



```
```{r echo=FALSE}

 expSpace2dViz(targetMat[,1],targetMat[,2],x.lab="P_ann_tot_m",y.lab="Temp_ann_avg_m")   

```

The argument ExSpArgs is responsible for shaping an exposure space, with "type" = "regGrid". "samp" indicates the number of points on each axis, and "bounds" provides the min and max values on each axis. To specify which attributes should become an axis, enter them in attPrim, a vector of Primary attributes. For example, the above space would have arguments:
```{r}

attSel<-attPrim<-c("P_ann_tot_m","Temp_ann_avg_m")     #In this case all specified attributes are on an axis

exSpArgs<-list(type = "regGrid",
               samp = c(7,6),
               bounds = list("P_ann_tot_m"=c(0.9,1.5), #bounds entries match the order in attSel
                             "Temp_ann_avg_m"=c(-1,4)))

```



# Example - Simple Scaling

One of the simplest ways to produce an exposure space is to simply scale the historical data records. In these instances P and PET are changed by a percentage, and temperature is changed additively. These changes occur at the daily time step. This package has the functionality to make simply scaled scenarios, by using the model tag "Simple-ann".

With this model techique, the complexity of attributes that can be altered is very limited. Each day in the historical time series is changed by the same amount. For this reason, simple scaling only supports changes to P and PET annual totals, and Temp annual averages. For this reason, attSel and attPrim are the same, and only have one entry per variable requested.

```{r}

modelTag="Simple-ann"

attSel<-attPrim<-c("P_ann_tot_m","Temp_ann_avg_m")

exSpArgs<-list(type = "regGrid",
               samp = c(7,6),
               bounds = list("P_ann_tot_m"=c(0.9,1.5),
                             "Temp_ann_avg_m"=c(-1,4)))

```
```{r}



```
This request of exSpArgs would produce the data for an exposure space identical to the one shown above. Note that due to historical scaling, the data will be of the same length of the observed record.

# Example - Stochastic Rainfall Temperature

For climate scenarios longer than the observed historical record, or manipulations of more complex attributes, stochastic weather generators must be used. In supplying a stochastic model tag for a variable, like "P-ann-wgen" for precipitaiton, the options of attributes to include in attSel will increase. However, the complete list of supported attributes will not work for all model types, due to different periods of analysis, or the internal structure of the model itself. Be sure to check the package documentation for valid and invalid model/attribute combinations. 

Another implication of using stochastic models is that an optimisation algorithm must be used to direct the model parameters to produce the target climate conditions. This algorithm is controlled by the argument optimArgs. See the package documentation for more explanation of each element. The defaults are shown below:

```{r}

optimArgs<-list(pcrossover=0.8,
                pmutation=0.1,
                maxiter=40,
                maxFitness=-0.001,
                popSize=100,
                run=15,
                parallel=FALSE,
                keepBest=TRUE,
                lambda.mult=0)

```

This optimisation algorithm uses an objective function of the form:

$$
OF=\sqrt{\sum_{i=1}^n(t_i-a_{si})^2}
$$

where the n attributes are provided in attSel, as shown below.

```{r}

modelTag=c("P-ann-wgen","Temp-har26-wgen")

attSel<-c("P_ann_tot_m","Temp_ann_avg_m","Temp_ann_P5_m","Temp_ann_P95_m")

attPrim<-c("P_ann_tot_m","Temp_ann_avg_m")

exSpArgs<-list(type = "regGrid",
               samp = c(7,6,1,1),
               bounds = list("P_ann_tot_m"=c(0.9,1.5),
                             "Temp_ann_avg_m"=c(-1,4),
                             "Temp_ann_P5_m"=1,
                             "Temp_ann_P95_m"=1))

```

Here, it is only requested than P_ann_tot_m and Temp_ann_avg_m are pertrubed on the axis of an exposure space, despite having additional terms in the objective function. These terms can 'dilute' the information the optimisation algorim recieves about guiding each attribute, causing good fits with some and not others. To help guide the algorithm, optimisation runs are used for one variable at a time. This effectivly forms subsets of the objective function equation. A further effort to prioritise the primary attributes is to add penalty terms to the objective function of the form:

$$
OF=\sqrt{\sum_{i=1}^n(t_i-a_{si})^2}+\lambda*(t_p-a_p)
$$

where $t_p$ and $a_p$ are additional terms for the primary attributes. While some experiments will aim to hold attributes constant while making an exposure space, there is also a structural reason to include more in attSel than attPrim. Using the inverse approach to guide a weather generator can sometimes lack enough information to preserve the realism of the stochastic data. For example, focussing just on Temp average, without considering T5 and T95, means that while the average temperature is correct the amplitude of the temperature pattern is not constrained. This can result in temperature values in peak summer and winter that are not realistic in any sense.

# Example - Rainfall with two primary attributes

In the previous example, each variable was treated with its own optimisation run. This meant that there was only one primary attribute to focus on each time. However there will be many cases where different attributes of a single variable are needed to be perturbed separately. In this case the optimisation problem is more challenging, as a small number of parameters is trying to change multiple attributes separately. The below example shows a case where the extremes of rainfall are to be perturbed separately from the annual total, while holding the maximum dry spell durations constant.

```{r}

modelTag=c("P-ann-wgen")

attSel<-attPrim<-c("P_ann_tot_m","P_ann_P99_m","P_ann_maxDSD_m")

attPrim<-c("P_ann_tot_m","P_ann_P99_m")

exSpArgs<-list(type = "regGrid",
               samp = c(3,3,1),
               bounds = list("P_ann_tot_m"=c(0.9,1.1),
                             "P_ann_P99_m"=c(0.9,1.1),
                             "P_ann_maxDSD_m"=1))

```



# References

Guo, D., S. Westra, and H. R. Maier (2016), An inverse approach to perturb historical rainfall data for scenario-neutral climate impact studies, Journal of Hydrology.






